---
title: "group_project"
author: "Johnstone Tcheou"
date: "2025-03-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(deSolve)
set.seed(8477)
```

## Data

```{r data}
load("data.contact.monthly.rda")
load("data.greaterPerth.2011.rda")
```

```{r exploratory}
#View(data.greaterPerth.2011)
```

```{r parms}
delta = 1/4 # inverse of latent period (days)
gamma_1 = 1/10 # inverse of infectious period for 1st exposure (days)
gamma_2 = 1/7 # inverse of infectious period for 2+ exposures (days)
omega = 0.7 # reduced infectiousness of those who have experienced at least 1 prior infection
sigma_e = 0.77 # reduced susceptibility due to previous exposure
nu = 1/230 # immunity period (days)

lambda = 1 # PLACEHOLDER VALUE 
# lambda(t) = force of infection; related to proportion of population that is infectious and incorporates seasonally-fluctuating transmission 

C = 0.015 # average minimum risk of hospitalization across all ages 
D = 0.2 # scaling factor lowering risk for those with prior exposure 

first_exposure_parms <- list(
 lambda = lambda,
 delta = delta,
 gamma = gamma_1,
 nu = nu,
 C = C,
 D = 1
)

previous_exposure_parms <- list(
  lambda = lambda,
  delta = delta,
  gamma = gamma_2,
  nu = nu,
  C = C,
  D = D
)


```

```{r seir}

N = 1669809 # total population of metropolitan Perth for ages 0 - 79

# test_num_grps <- function(num_grp) {
#   
#   if (num_grp <= 60) {
#       total_grps = num_grp
#     } else {
#       num_one_mo_grps <- 60
#       num_five_yr_grps <- ceiling((num_grp - 60)/5)
#       total_grps <- num_one_mo_grps + num_five_yr_grps
#     }
#     
#   return(total_grps)
# }
# 
# 
# test_num_grps(75) # expected output - 63; 60 1 mo groups, 3 5 yr groups thereafter

rsv_base <- function(num_grp) {
  with(as.list(c(num_grp)), {
    
    # 75 age groups, where 1-60 = 1 month groups (for ppl under 5)
    # 5 yr groups after
    
    # to get number of 5 yr groups
    
    if (num_grp <= 60) {
      total_grps = num_grp
    } else {
      num_one_mo_grps <- 60
      num_five_yr_grps <- ceiling((num_grp - 60)/5)
      total_grps <- num_one_mo_grps + num_five_yr_grps
    }
    
    total_grps <- total_grps * 2 # need to double amount of grps to account for naive and subsequent exposures
    
    # initialize the state variables using the same order passed in
    
    # use variable to specify number of groups, so first 1:total_grps are for susceptibles
    S_naive = state[1:total_grps] 
    
    # then total_grps:grp+1:total_grps+num:grp are E columns
    E_naive = state[total_grps + (1:total_grps)]
    
    # shift again by 1:total_grps for I columns
    I_naive = state[total_grps * 2 + (1:total_grps)]
    
    # shift again for R cols
    R_naive = state[total_grps * 3 + (1:total_grps)]
    
    
    # use variable to specify number of groups, so first 1:total_grps are for susceptibles
    S_subsequent = state[total_grps * 4 + (1:total_grps)] 
    
    # then total_grps:grp+1:total_grps+num:grp are E columns
    E_subsequent = state[total_grps * 5 + (1:total_grps)]
    
    # shift again by 1:total_grps for I columns
    I_subsequent = state[total_grps * 6 + (1:total_grps)]
    
    # shift again for R cols
    R_subsequent = state[total_grps * 7 + (1:total_grps)]
    
    
    
    #length = 4 * total_grps bc 4 different state vars (S, E, I, R) for each grp
    ODES <- vector(length = 4*total_grps) # place holder for the equations: 4 state variables (S, I, A, cumA)
    
    # make sure the order of ode eqns. and state variables are the same!
    for (i in 1:num_grp){
      
      
      ODES[i] = paste("S_naive", i, "months", sep = "_")
      ODES[num_grp+i] = paste("E_naive", i, "months", sep = "_")
      ODES[num_grp*2+i] = paste("I_naive", i, "months", sep = "_")
      ODES[num_grp*3+i] = paste("R_naive", i, "months", sep = "_")
      
      ODES[num_grp*4+i] = paste("S_subsequent", i, "months", sep = "_")
      ODES[num_grp*5+i] = paste("E_subsequent", i, "months", sep = "_")
      ODES[num_grp*6+i] = paste("I_subsequent", i, "months", sep = "_")
      ODES[num_grp*7+i] = paste("R_subsequent", i, "months", sep = "_")
      
      # infection = sum(BETA[i,] * I) * S[i] # new infections
      # ODES[i] = NU[i] - infection - mu * S[i]  # corresponds to dS/dt chunk from one at a time coding
      # ODES[num_grp + i] = infection - mu * I[i] - gamma * I[i] # corresponds to dI/dt chunk
      # ODES[num_grp * 2 + i] = d * gamma * I[i] - mu * A[i] - m * A[i]  # corresponds to dA/dt
      # ODES[num_grp * 3 + i] =  d * gamma * I[i] # dcumA/d: cumulative incidence
    }
    list(ODES) # ensure you use list() instead of c() as the colnames will have parameter names and more intuitive 
  })
}

num_grp <- 75

test_df <- rsv_base(num_grp)
num_grp = 5 # number of risk groups
mu=.0312;  # in years
N=c(.06,.31,.52,.08,.03); # population in each group
NU=mu*N; # recruits to each group
gamma=.2; m=1; d=.3; # in years
beta=.0217; # scaling factor
BETA=matrix(c(rep(0,5),
              0,.65,2.15,12.9,21.5,
              0,2.15,7.17,43.1,71.8,
              0,12.9,43.1,258,431,
              0,21.5,71.8,431,718),5,5,byrow=T)*beta
I0=c(0,0,0,0,1e-5);
S0=N-I0;
A0=cumA0=rep(0,5);

# CAUTION: NOTE HERE WE CODE THE PARAMETER SET AS A LIST, SO VARIABLE NAMES ARE PRESERVED 
parameters=list(BETA=BETA,mu=mu,gamma=gamma,m=m,d=d,
             NU=NU) # use list here for vectors etc.

state=c(S=S0, I=I0, A=A0, cumA=cumA0) # only numeric variables are acceptable for state
times=0:100;

simHIV_alt=ode(y=state,times=times,func=HIV5riskGrs_alt,parms=parameters);


# SAMPLE CODE FOR PROCESSING MODEL OUTPUT FOR EACH GROUP AND AGGREGATE ALL GROUPS
# incidence per 1000 for each group
Incidence_alt=(simHIV_alt[-1,paste0('cumA', 1:num_grp)]-
             simHIV_alt[-length(times),paste0('cumA', 1:num_grp)])/
  matrix(N,100,5,byrow=T)*1000
# total incidence per 1000 population
totInci_alt=rowSums((simHIV_alt[-1,paste0('cumA', 1:num_grp)]-
                   simHIV_alt[-length(times),paste0('cumA', 1:num_grp)]))*1e3

# susceptibility for each group
S_alt=simHIV_alt[,paste0('S', 1:num_grp)]/matrix(N,101,5,byrow=T)*100
# susceptibility combining all groups
totS_alt=rowSums(simHIV_alt[,paste0('S', 1:num_grp)])*100

## plot results
par(mfrow=c(1,1),cex=1.2,mar=c(3,3,1,1),mgp=c(1.8,.5,0))
matplot(Incidence_alt[,2:5],type='l',lty=2:5,col='black',lwd=1.5,ylim=c(0,35),
        ylab='Incidence AIDS per year per 1000',xlab='Time (years)')
lines(totInci_alt,lwd=2)
legend('topright',leg=c('1-5','6-50','51-100','100+','total'),lty=c(2:5,1),
       col='black',lwd=c(rep(1.5,4),2),cex=.9,bty='n')


```

